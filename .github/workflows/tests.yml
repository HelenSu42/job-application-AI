name: Tests

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install backend dependencies
        working-directory: backend
        run: npm install --no-fund --no-audit

      - name: Run backend tests (if any)
        working-directory: backend
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar nullglob
          files=(**/*.test.ts **/*.test.tsx **/*.test.js **/*.test.jsx)
          if [ ${#files[@]} -gt 0 ]; then
            echo "Found ${#files[@]} backend test files"
            npm run test
          else
            echo "No backend tests found; skipping."
          fi